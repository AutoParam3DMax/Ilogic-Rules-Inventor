Sub main

    Dim oZespol As AssemblyDocument
    oZespol = ThisApplication.ActiveDocument

    Dim oZespolDef As ComponentDefinition
    oZespolDef = oZespol.ComponentDefinition


    Dim SciezkaEksportu As String = ""


    Dim wybor As Integer
    wybor = MsgBox("Select the DXF export method:" & vbCrLf & _
                   "TAK = export to the folder with the main assembly" & vbCrLf & _
                   "NIE = selecting a folder in Windows", vbYesNoCancel + vbQuestion, "Export DXF")

    If wybor = vbCancel Then Exit Sub

    If wybor = vbYes Then

        Dim poz As Integer = InStrRev(oZespol.FullDocumentName, "\")
        SciezkaEksportu = Left(oZespol.FullDocumentName, poz)
    Else

        SciezkaEksportu = WybierzFolder()
        If SciezkaEksportu = "" Then
            MsgBox("No folder selected. Export canceled.", vbExclamation, "Cancelled")
            Exit Sub
        End If
    End If

 
    Dim oComp As ComponentOccurrence
    Dim oCompDef As ComponentDefinition

    For Each oComp In oZespolDef.Occurrences.AllLeafOccurrences
        If oComp.Suppressed Then Continue For

        Try
            oCompDef = oComp.Definition
        Catch ex As Exception
            Continue For
        End Try

        If oCompDef.Type = kSheetMetalComponentDefinitionObject Then
            GenerujDXF(oCompDef, SciezkaEksportu)
        End If

    Next

    MsgBox("DXF export completed.", vbInformation, "iLogic DXF Generator")

End Sub



Private Function WybierzFolder() As String
    Dim dlg As Object
    dlg = CreateObject("Shell.Application").BrowseForFolder(0, "Select the folder to save the DXF file", 0, 0)
    If Not dlg Is Nothing Then
        WybierzFolder = dlg.Self.Path & "\"
    Else
        WybierzFolder = ""
    End If
End Function

Private Sub GenerujDXF(oDef As SheetMetalComponentDefinition, SciezkaEksportu As String)

    Dim oDoc As Document = oDef.Document

    If oDef.HasFlatPattern = False Then
        Try
            oDef.Unfold
        Catch ex As Exception
            Exit Sub
        End Try
    End If
	

    Dim Nazwa As String = oDoc.PropertySets.Item("Design Tracking Properties").Item("Part Number").Value
	If Nazwa = "" Then Nazwa = oDoc.DisplayName
	
    Dim poz As Integer = InStrRev(Nazwa, "-")
	
	If Nazwa.EndsWith(".ipt") Then
		Nazwa = Nazwa.Replace(".ipt", "")
	End If
	
	If poz > 0 Then
		Nazwa = Mid(Nazwa, poz + 1)
	End If
	
    Nazwa = Nazwa & ".dxf"

    Dim pelnaSciezkaDXF As String = SciezkaEksportu & Nazwa

    DXFOption = "FLAT PATTERN DXF?AcadVersion=2000&InvisibleLayers=IV_Tangent;IV_ARC_CENTERS;IV_FEATURE_PROFILES;IV_BEND_DOWN;IV_BEND;IV_FEATURE_PROFILES_DOWN" 

    Try
        oDef.DataIO.WriteDataToFile(DXFOption, pelnaSciezkaDXF)
    Catch ex As Exception
    End Try

End Sub

