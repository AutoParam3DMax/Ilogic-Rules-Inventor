Sub main

    Dim oZespol As AssemblyDocument
    oZespol = ThisApplication.ActiveDocument

    Dim oZespolDef As ComponentDefinition
    oZespolDef = oZespol.ComponentDefinition

    Dim oComp As ComponentOccurrence
    Dim oCompDef As ComponentDefinition

    For Each oComp In oZespolDef.Occurrences ' Przeszukujemy przez cały zespół

        ' --- OBSŁUGA WYŁĄCZONYCH (SUPPRESSED) ELEMENTÓW ---
        If oComp.Suppressed Then
            GoTo pominGlowny
        End If

        Try
            oCompDef = oComp.Definition
        Catch ex As Exception
            GoTo pominGlowny
        End Try

        If oCompDef.Type = kAssemblyComponentDefinitionObject Or oCompDef.Type = kWeldmentComponentDefinitionObject Then
            SzukajPodzespol(oCompDef) ' Przekazujemy DEFINICJĘ podzespołu
        ElseIf oCompDef.Type = kSheetMetalComponentDefinitionObject Or oCompDef.Type = kPartComponentDefinitionObject Then
            Try
                If oCompDef.IsContentMember Then
                    GoTo pominGlowny
                End If
            Catch ex As Exception
                GoTo pominGlowny
            End Try

            If oCompDef.Type = kSheetMetalComponentDefinitionObject Then
                GenerujDXF(oCompDef)
            ElseIf oCompDef.Type = kPartComponentDefinitionObject Then
            End If
        Else
            MsgBox("NIEZNANY TYP KOMPONENTU: " & oComp.Name & " (Typ: " & oCompDef.Type & "). Pomijam.", , "Inny Typ")
        End If

    pominGlowny:
    Next
    MsgBox("Skanowanie głównego złożenia ZAKOŃCZONE.", , "iLogic DXF Generator")
End Sub

Private Sub SzukajPodzespol(ocompdef As ComponentDefinition) ' Funkcja rekurencyjna

    If ocompdef.Occurrences.Count = 0 Then
        Exit Sub
    End If

    Dim oSubComp As ComponentOccurrence
    Dim oSubCompDef As ComponentDefinition

    For Each oSubComp In ocompdef.Occurrences

        If oSubComp.Suppressed Then
            GoTo pominPodElement
        End If

        Try
            oSubCompDef = oSubComp.Definition
        Catch ex As Exception     
            GoTo pominPodElement
        End Try

        If oSubCompDef.Type = kAssemblyComponentDefinitionObject Or oSubCompDef.Type = kWeldmentComponentDefinitionObject Then
            SzukajPodzespol(oSubCompDef) ' REKURENCJA! Przekazujemy DEFINICJĘ podzłożenia
        ElseIf oSubCompDef.Type = kSheetMetalComponentDefinitionObject Or oSubCompDef.Type = kPartComponentDefinitionObject Then
            Try
                If oSubCompDef.IsContentMember Then
                    GoTo pominPodElement
                End If
            Catch ex As Exception
                GoTo pominPodElement
            End Try

            If oSubCompDef.Type = kSheetMetalComponentDefinitionObject Then
                GenerujDXF(oSubCompDef)
            End If
        Else
           
        End If

    pominPodElement:
    Next
End Sub

Private Sub GenerujDXF(oDef As SheetMetalComponentDefinition)

    Dim oDoc As Document = oDef.Document

    If oDef.HasFlatPattern = False Then
        Try
            oDef.Unfold
        Catch ex As Exception
            Exit Sub
        End Try
    End If

    Dim poz As Integer
    poz = InStrRev(oDoc.FullDocumentName, "\")

    Dim sciezka As String
    sciezka = Mid(oDoc.FullFileName, 1, poz)

    Dim Nazwa As String
    poz = InStrRev(oDoc.DisplayName, "-")
    If poz > 0 Then
        If poz + 1 <= oDoc.DisplayName.Length Then
            Nazwa = Mid(oDoc.DisplayName, poz + 1).Replace(".ipt", "")
        Else
            Nazwa = oDoc.DisplayName.Replace(".ipt", "")
        End If
    Else
        Nazwa = oDoc.DisplayName.Replace(".ipt", "")
    End If

    If Not Nazwa.ToLower().EndsWith(".dxf") Then
        Nazwa = Nazwa & ".dxf"
    End If

    Dim pelnaSciezkaDXF As String = sciezka & Nazwa

    DXFOption = "FLAT PATTERN DXF?AcadVersion=2000&InvisibleLayers=IV_Tangent;IV_ARC_CENTERS;IV_FEATURE_PROFILES;IV_FEATURE_PROFILES_DOWN;IV_BEND_DOWN;IV_BEND"

    Try
        oDef.DataIO.WriteDataToFile(DXFOption, pelnaSciezkaDXF)
    Catch ex As Exception
    End Try
End Sub

